var urlObject,userPlatformId;urlObject||(urlObject=new URL(location),console.log("has urlObject ")),urlObject.searchParams.get("key")&&(userPlatformId=urlObject.searchParams.get("key"));var convertedVapidKey,host="https://sdk.truepush.com/",statsHost="https://stats.truepush.com/",campaignStats=statsHost+"api/v1/viewsAndClicks",welcomeNotificationStats=statsHost+"api/v1/welomeNotificationStats",awsStatsHost="https://lqt6f6d8gl.execute-api.ap-south-1.amazonaws.com/beta/stats";const WorkerMessengerCommand={AMP_SUBSCRIPTION_STATE:"amp-web-push-subscription-state",AMP_SUBSCRIBE:"amp-web-push-subscribe",AMP_UNSUBSCRIBE:"amp-web-push-unsubscribe"};try{function urlB64ToUint8Array(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(t),o=new Uint8Array(n.length),a=0;a<n.length;++a)o[a]=n.charCodeAt(a);return o}function onMessageReceivedSubscriptionState(){let e=null;self.registration.pushManager.getSubscription().then(t=>(e=t,t?self.registration.pushManager.permissionState(t.options):null)).then(t=>{if(null==t)broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,!1);else{const n=!!e&&"granted"===t;broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,n)}})}function onMessageReceivedSubscribe(){self.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlB64ToUint8Array(convertedVapidKey)}).then(e=>{broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIBE,null)})}function onMessageReceivedUnsubscribe(){self.registration.pushManager.getSubscription().then(e=>e.unsubscribe()).then(()=>{broadcastReply(WorkerMessengerCommand.AMP_UNSUBSCRIBE,null)})}function broadcastReply(e,t){self.clients.matchAll().then(n=>{for(const o of n)o.postMessage({command:e,payload:t})})}var payload,logdata,app_image_url,icon_url,image_url,badge_url,notificationClicked,log_data,notificationAutoHide=!1;self.addEventListener("push",function(e){if(console.log(e),null===e.data)console.log("No data found",e.data);else{var t=e.data.json();console.log("notif palyload iss ",t),t.data&&t.data.type&&(t=JSON.parse(t.data.payload)),t.data&&!t.data.skipNotification?(t.data.userPlatformId&&(userPlatformId=t.data.userPlatformId),e.waitUntil(self.registration.showNotification(t.title,t).then(function(){t.data.skipReport?console.log("skipping report"):checkCache().then(function(e){console.log("globalData iss ",e),e&&(e.browserInfo&&(t.data.browserInfo=e.browserInfo),e.countryCode&&(t.data.countryCode=e.countryCode),e.subscriberId&&(t.data.subscriberId=e.subscriberId),e.appId&&(t.data.appId=e.appId),t.data.platformType="website");var n={campaignData:t.data,eventType:"default",event:"view",subscription:e.subscription};let o=campaignStats;t.data.aws&&(o=awsStatsHost),fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(function(e){}).catch(e=>{console.error(e)})}).catch(function(e){console.log(e)})}).catch(function(e){console.log("error while showing notification",e)}))):t.notification?self.registration.showNotification(t.notification.title,t.notification):console.log("no data found in payload Object")}});var clickFlag=0,clickArr=[];function findIndex(e,t){return e.findIndex(e=>e.action===t)}function FormatPayload(e){return new Promise(function(t,n){e&&e.data&&e.data.text()?t(JSON.parse(e.data.text())):(payload='{"title":"Back up notification","body":"Backup notification body","requireInteraction":false, "data":"{}"}',t(JSON.parse(payload)))})}self.onnotificationclick=function(e){console.log("On notification click: ",e)},self.addEventListener("notificationclick",function(e){e.notification.close(),clickFlag=1;var t={enable:!1,url:""},n=e.notification.data;if(console.log("---click data",n,e),n)if(-1==clickArr.indexOf(n.campaignId)){clickArr.length>=10&&(clickArr=[]),console.log("click arary is ",clickArr);var o={campaignData:n};if(null==e.action||""==e.action)o.eventType="default",o.event="click",""!=n.link&&void 0!=n.link&&null!=n.link&&(t.enable=!0,t.url=n.link);else if(n.actions&&n.actions[e.action]){let a=n.actions[e.action];o.eventType="action",o.event=e.action,""!=a.link&&(t.enable=!0,t.url=a.link)}if(n.skipReport||(clickArr.push(n.campaignId),checkCache().then(function(e){e&&(e.browserInfo&&(n.browserInfo=e.browserInfo),e.countryCode&&(n.countryCode=e.countryCode),e.subscriberId&&(n.subscriberId=e.subscriberId),e.appId&&(n.appId=e.appId),n.platformType="website"),o.subscription=e.subscription;let t=campaignStats;n.aws&&(t=awsStatsHost),fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(e){clickFlag=0}).catch(e=>{console.log(e)})}).catch(function(e){console.log(e)})),n.isWelcomeNotification){var a={platformId:n.platformId,event:"click"};fetch(welcomeNotificationStats,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)}).then(function(e){},function(e){console.error("Error in updating in welcome notification Details")})}t.enable&&e.waitUntil(clients.openWindow(t.url))}else console.log("duplicate click notification ",n);else console.log("data not found ",n)}),self.addEventListener("install",function(e){e.waitUntil(self.skipWaiting())}),self.addEventListener("notificationclose",function(e){}),self.addEventListener("activate",function(e){e.waitUntil(self.clients.claim())}),self.addEventListener("pushsubscriptionchange",function(e){console.log("pushSubscription changed ",e),userPlatformId&&e.waitUntil(registration.pushManager.subscribe().then(function(t){t=CheckForKeys(t),e.oldSubscription=e.oldSubscription?CheckForKeys(e.oldSubscription):"Old subscription";var n={oldSubscription:e.oldSubscription,subscription:t,userPlatformId:userPlatformId};fetch(host+"api/v1/upsertSubscriber",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}).then(function(e){}).catch(function(e){})}).catch(function(e){}))}),self.addEventListener("message",e=>{if(console.log(e),e.data&&e.data.key)convertedVapidKey=e.data.key;else{const{command:t}=e.data;switch(t){case WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE:onMessageReceivedSubscriptionState();break;case WorkerMessengerCommand.AMP_SUBSCRIBE:onMessageReceivedSubscribe();break;case WorkerMessengerCommand.AMP_UNSUBSCRIBE:onMessageReceivedUnsubscribe()}}})}catch(e){console.log("error is",e)}function notificationClicked(e){console.log("notificationclose event")}function CheckForKeys(e){var t=JSON.parse(JSON.stringify(e));t.keys||(t.keys={auth:ConvertToB64SafeUrl(btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("auth"))))),p256dh:ConvertToB64SafeUrl(btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("p256dh")))))});let n={};return n.endpoint=t.endpoint,n.keys={},n.keys.p256dh=t.keys.p256dh,n.keys.auth=t.keys.auth,n}function ConvertToB64SafeUrl(e){return e=(e=(e=e.split("=")[0]).replace(/\+/g,"-")).replace(/\//g,"_")}function checkCache(){let e={version:"v2.0.3"};return new Promise((t,n)=>{self.registration.pushManager.getSubscription().then(function(o){o?(o=CheckForKeys(o),e.subscription=o,userPlatformId&&(e.userPlatformId=userPlatformId),"caches"in self?caches.open("truepush-cache").then(function(a){a.match("/truepush-details.json").then(function(i){if(i)i.json().then(i=>{if(i.subscription&&i.subscription.endpoint&&i.subscription.endpoint==o.endpoint)t(i);else{const o={headers:{"Content-Type":"application/json"}};fetch(host+"api/v1/getSubscriberDetailsAll",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}).then(e=>e.json()).then(n=>{n&&n.data&&n.data.browserInfo&&(e.subscriberId=n.data._id,e.appId=n.data.appId,n.data.browserInfo&&(e.browserInfo=n.data.browserInfo),n.data.countryCode&&(e.countryCode=n.data.countryCode));let i=new Response(JSON.stringify(e),o);a.put("/truepush-details.json",i),t(e)}).catch(function(e){n("error in getSubscriberDetails")})}}).catch(function(e){n("error in version.json")});else{const o={headers:{"Content-Type":"application/json"}};fetch(host+"api/v1/getSubscriberDetailsAll",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}).then(e=>e.json()).then(n=>{n&&n.data&&n.data.browserInfo&&(e.subscriberId=n.data._id,e.appId=n.data.appId,n.data.browserInfo&&(e.browserInfo=n.data.browserInfo),n.data.countryCode&&(e.countryCode=n.data.countryCode));let i=new Response(JSON.stringify(e),o);a.put("/truepush-details.json",i),t(e)}).catch(function(e){n("error in getSubscriberDetails")})}})}).catch(function(e){n("error in caches.open")}):fetch(host+"api/v1/getSubscriberDetailsAll",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}).then(e=>e.json()).then(n=>{n&&n.data&&n.data.browserInfo&&(e.subscriberId=n.data._id,e.appId=n.data.appId,n.data.browserInfo&&(e.browserInfo=n.data.browserInfo),n.data.countryCode&&(e.countryCode=n.data.countryCode)),t(e)},function(e){n("error in getSubscriberDetails")})):n("not subscribed.")}).catch(function(e){n("error while getting subscription")})})}
